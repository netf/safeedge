// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: rollout_device_status.sql

package generated

import (
	"context"

	"github.com/google/uuid"
)

const countRolloutDevicesByStatus = `-- name: CountRolloutDevicesByStatus :one
SELECT COUNT(*) FROM rollout_device_status
WHERE rollout_id = $1 AND status = $2
`

type CountRolloutDevicesByStatusParams struct {
	RolloutID uuid.UUID `json:"rollout_id"`
	Status    string    `json:"status"`
}

func (q *Queries) CountRolloutDevicesByStatus(ctx context.Context, arg CountRolloutDevicesByStatusParams) (int64, error) {
	row := q.db.QueryRow(ctx, countRolloutDevicesByStatus, arg.RolloutID, arg.Status)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createRolloutDeviceStatus = `-- name: CreateRolloutDeviceStatus :one
INSERT INTO rollout_device_status (
  rollout_id,
  device_id,
  is_canary,
  status
) VALUES (
  $1, $2, $3, 'PENDING'
)
RETURNING rollout_id, device_id, is_canary, status, health_check_result, updated_at
`

type CreateRolloutDeviceStatusParams struct {
	RolloutID uuid.UUID `json:"rollout_id"`
	DeviceID  uuid.UUID `json:"device_id"`
	IsCanary  bool      `json:"is_canary"`
}

func (q *Queries) CreateRolloutDeviceStatus(ctx context.Context, arg CreateRolloutDeviceStatusParams) (RolloutDeviceStatus, error) {
	row := q.db.QueryRow(ctx, createRolloutDeviceStatus, arg.RolloutID, arg.DeviceID, arg.IsCanary)
	var i RolloutDeviceStatus
	err := row.Scan(
		&i.RolloutID,
		&i.DeviceID,
		&i.IsCanary,
		&i.Status,
		&i.HealthCheckResult,
		&i.UpdatedAt,
	)
	return i, err
}

const getCanaryDevices = `-- name: GetCanaryDevices :many
SELECT rollout_id, device_id, is_canary, status, health_check_result, updated_at FROM rollout_device_status
WHERE rollout_id = $1 AND is_canary = true
ORDER BY updated_at ASC
`

func (q *Queries) GetCanaryDevices(ctx context.Context, rolloutID uuid.UUID) ([]RolloutDeviceStatus, error) {
	rows, err := q.db.Query(ctx, getCanaryDevices, rolloutID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []RolloutDeviceStatus{}
	for rows.Next() {
		var i RolloutDeviceStatus
		if err := rows.Scan(
			&i.RolloutID,
			&i.DeviceID,
			&i.IsCanary,
			&i.Status,
			&i.HealthCheckResult,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getRolloutDeviceStatus = `-- name: GetRolloutDeviceStatus :one
SELECT rollout_id, device_id, is_canary, status, health_check_result, updated_at FROM rollout_device_status
WHERE rollout_id = $1 AND device_id = $2
`

type GetRolloutDeviceStatusParams struct {
	RolloutID uuid.UUID `json:"rollout_id"`
	DeviceID  uuid.UUID `json:"device_id"`
}

func (q *Queries) GetRolloutDeviceStatus(ctx context.Context, arg GetRolloutDeviceStatusParams) (RolloutDeviceStatus, error) {
	row := q.db.QueryRow(ctx, getRolloutDeviceStatus, arg.RolloutID, arg.DeviceID)
	var i RolloutDeviceStatus
	err := row.Scan(
		&i.RolloutID,
		&i.DeviceID,
		&i.IsCanary,
		&i.Status,
		&i.HealthCheckResult,
		&i.UpdatedAt,
	)
	return i, err
}

const listRolloutDeviceStatuses = `-- name: ListRolloutDeviceStatuses :many
SELECT rollout_id, device_id, is_canary, status, health_check_result, updated_at FROM rollout_device_status
WHERE rollout_id = $1
ORDER BY is_canary DESC, updated_at ASC
`

func (q *Queries) ListRolloutDeviceStatuses(ctx context.Context, rolloutID uuid.UUID) ([]RolloutDeviceStatus, error) {
	rows, err := q.db.Query(ctx, listRolloutDeviceStatuses, rolloutID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []RolloutDeviceStatus{}
	for rows.Next() {
		var i RolloutDeviceStatus
		if err := rows.Scan(
			&i.RolloutID,
			&i.DeviceID,
			&i.IsCanary,
			&i.Status,
			&i.HealthCheckResult,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateRolloutDeviceStatus = `-- name: UpdateRolloutDeviceStatus :one
UPDATE rollout_device_status
SET status = $3, health_check_result = $4, updated_at = NOW()
WHERE rollout_id = $1 AND device_id = $2
RETURNING rollout_id, device_id, is_canary, status, health_check_result, updated_at
`

type UpdateRolloutDeviceStatusParams struct {
	RolloutID         uuid.UUID `json:"rollout_id"`
	DeviceID          uuid.UUID `json:"device_id"`
	Status            string    `json:"status"`
	HealthCheckResult []byte    `json:"health_check_result"`
}

func (q *Queries) UpdateRolloutDeviceStatus(ctx context.Context, arg UpdateRolloutDeviceStatusParams) (RolloutDeviceStatus, error) {
	row := q.db.QueryRow(ctx, updateRolloutDeviceStatus,
		arg.RolloutID,
		arg.DeviceID,
		arg.Status,
		arg.HealthCheckResult,
	)
	var i RolloutDeviceStatus
	err := row.Scan(
		&i.RolloutID,
		&i.DeviceID,
		&i.IsCanary,
		&i.Status,
		&i.HealthCheckResult,
		&i.UpdatedAt,
	)
	return i, err
}
